<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Echo RAG – Run Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; color: #111; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; background: #fff; }
    h1 { font-size: 22px; margin: 0 0 8px; }
    h2 { font-size: 18px; margin: 16px 0 8px; }
    h3 { font-size: 16px; margin: 12px 0 6px; }
    textarea { width: 100%; min-height: 220px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    code, pre { background: #f8fafc; border-radius: 8px; padding: 10px; display: block; white-space: pre-wrap; }
    .muted { color: #6b7280; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #e5e7eb; border-radius:9999px; margin-right:6px; font-size:12px; }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }
    ul { margin: 6px 0 0 18px; }
  </style>
</head>
<body>
  <div id="app">
    <h1>Echo RAG – Run <span id="runId" class="muted"></span></h1>
    <div class="muted" style="margin-bottom:12px">
      <a id="jsonLink" href="#" target="_blank">Open raw JSON</a>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Draft</h2>
        <textarea id="draft" readonly></textarea>
      </div>

      <div class="card">
        <h2>Retrieval (top snippets)</h2>
        <div id="snippets"></div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px">
      <div class="card">
        <h2>Editorial rollup</h2>
        <div id="editorial"></div>
      </div>
      <div class="card">
        <h2>Audience rollup</h2>
        <div id="audience"></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h2>Headline ideas</h2>
      <ul id="headlines"></ul>
    </div>
  </div>

  <script>
    (function () {
      const runId = "{{ run_id }}";
      document.getElementById("runId").textContent = runId;
      document.getElementById("jsonLink").href = "/api/run/" + encodeURIComponent(runId);

      // Helper to create a pill span with safe text
      function createPill(text) {
        const span = document.createElement("span");
        span.className = "pill";
        span.textContent = text;
        return span;
      }

      // Helper to create a list item with text and optional muted count
      function createListItem(text, count) {
        const li = document.createElement("li");
        li.textContent = text + " ";
        if (count !== undefined) {
          const muted = document.createElement("span");
          muted.className = "muted";
          muted.textContent = "(" + count + ")";
          li.appendChild(muted);
        }
        return li;
      }

      fetch("/api/run/" + encodeURIComponent(runId))
        .then(function(r) { return r.json(); })
        .then(function(response) {
          var ok = response.ok;
          var data = response.data;
          if (!ok) throw new Error("Run not found");

          // Draft
          document.getElementById("draft").value = (data && data.input && data.input.draft || "").trim();

          // Retrieval
          var snippets = (data && data.retrieval && data.retrieval.snippets || []).slice(0, 8);
          var snDiv = document.getElementById("snippets");
          snDiv.textContent = ""; // Clear

          if (!snippets.length) {
            var noSnippets = document.createElement("div");
            noSnippets.className = "muted";
            noSnippets.textContent = "No snippets.";
            snDiv.appendChild(noSnippets);
          } else {
            snippets.forEach(function(s) {
              var el = document.createElement("div");
              el.style.marginBottom = "10px";

              var metaDiv = document.createElement("div");
              metaDiv.className = "muted";
              metaDiv.textContent = "[" + (s.idx || "") + "] " + (s.source || "") + " (chunk " + (s.chunk_index || "") + ") • score " + Number(s.score || 0).toFixed(3);
              el.appendChild(metaDiv);

              var pre = document.createElement("pre");
              pre.textContent = s.text || "";
              el.appendChild(pre);

              snDiv.appendChild(el);
            });
          }

          // Editorial rollup
          var ed = (data && data.editorial && data.editorial.rollup) || {};
          var edDiv = document.getElementById("editorial");
          edDiv.textContent = ""; // Clear

          var scoresAvg = ed.scores_avg || {};
          var scoresDiv = document.createElement("div");
          scoresDiv.textContent = "Scores avg: ";
          Object.keys(scoresAvg).forEach(function(k) {
            scoresDiv.appendChild(createPill(k + ": " + (scoresAvg[k] != null ? scoresAvg[k] : "-")));
          });
          edDiv.appendChild(scoresDiv);

          var suggTitle = document.createElement("h3");
          suggTitle.textContent = "Top suggestions";
          edDiv.appendChild(suggTitle);

          var suggList = document.createElement("ul");
          var sugg = (ed.consensus_suggestions || []).slice(0, 8);
          if (sugg.length) {
            sugg.forEach(function(s) {
              suggList.appendChild(createListItem(s.item || "", s.count));
            });
          }
          edDiv.appendChild(suggList);

          var risksTitle = document.createElement("h3");
          risksTitle.textContent = "Top risks";
          edDiv.appendChild(risksTitle);

          var risksList = document.createElement("ul");
          var risks = (ed.consensus_risks || []).slice(0, 8);
          if (risks.length) {
            risks.forEach(function(s) {
              risksList.appendChild(createListItem(s.item || "", s.count));
            });
          }
          edDiv.appendChild(risksList);

          // Audience rollup
          var au = (data && data.audience && data.audience.rollup) || {};
          var auDiv = document.getElementById("audience");
          auDiv.textContent = ""; // Clear

          var avg = au.avg_scores || {};
          var avgDiv = document.createElement("div");
          avgDiv.textContent = "Avg: ";
          avgDiv.appendChild(createPill("trust: " + (avg.trust != null ? avg.trust : "-")));
          avgDiv.appendChild(createPill("relevance: " + (avg.relevance != null ? avg.relevance : "-")));
          avgDiv.appendChild(createPill("share: " + (avg.share_intent != null ? avg.share_intent : "-")));
          auDiv.appendChild(avgDiv);

          var stance = au.stance_counts || {};
          var stanceDiv = document.createElement("div");
          stanceDiv.style.marginTop = "6px";
          stanceDiv.textContent = "Stance: ";
          Object.keys(stance).forEach(function(k) {
            stanceDiv.appendChild(createPill(k + ": " + stance[k]));
          });
          auDiv.appendChild(stanceDiv);

          var concernsTitle = document.createElement("h3");
          concernsTitle.textContent = "Top concerns";
          auDiv.appendChild(concernsTitle);

          var concernsList = document.createElement("ul");
          var concerns = (au.top_concerns || []).slice(0, 8);
          if (concerns.length) {
            concerns.forEach(function(s) {
              concernsList.appendChild(createListItem(s.item || "", s.count));
            });
          }
          auDiv.appendChild(concernsList);

          var questionsTitle = document.createElement("h3");
          questionsTitle.textContent = "Top questions";
          auDiv.appendChild(questionsTitle);

          var questionsList = document.createElement("ul");
          var questions = (au.top_questions || []).slice(0, 8);
          if (questions.length) {
            questions.forEach(function(s) {
              questionsList.appendChild(createListItem(s.item || "", s.count));
            });
          }
          auDiv.appendChild(questionsList);

          // Headlines
          var heads = (data && data.editorial && data.editorial.headline_pool || []).slice(0, 12);
          var headlinesList = document.getElementById("headlines");
          headlinesList.textContent = ""; // Clear

          if (heads.length) {
            heads.forEach(function(h) {
              var li = document.createElement("li");
              li.textContent = h;
              headlinesList.appendChild(li);
            });
          } else {
            var noneLi = document.createElement("li");
            noneLi.className = "muted";
            noneLi.textContent = "None.";
            headlinesList.appendChild(noneLi);
          }
        })
        .catch(function(err) {
          alert("Failed to load run: " + err.message);
        });
    })();
  </script>
</body>
</html>
